<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>
        
            PokemonGo：LBS游戏开发 - Meitu FE
        
    </title>
    <meta name="keywords" content="">
    <meta name="description" content="">
    <link rel="shortcut icon" href="/favicon.ico">
    <link rel="stylesheet" href="/dist/css/github-gist.css">
    <link rel="stylesheet" href="/dist/css/app.css">
</head>


<body data-page="article">


<header class="header">
    <nav class="nav">
        <div class="container">
            <div class="logo">
                <a href="http://fe.meitu.com">
                    <img src="/images/logo.png" alt="Meitu FE">
                </a>
            </div>
            <ul class="menu">
                
                <li><a href="/">HOME</a></li>
                
                <li><a href="https://github.com/meitufe">GITHUB</a></li>
                
            </ul>
        </div>
    </nav>
</header>


<div class="page-content">
    <div class="container">
        <article class="article">
            <header class="article-header">
                <h1 class="article-title">PokemonGo：LBS游戏开发</h1>
                <div class="article-meta">
                    <span>guowc</span>
                    <span>publish at</span>
                    <time class="article-date" datetime="2017-08-08">2017-08-08</time>
                </div>
            </header>
            <section class="article-content">
                 <blockquote>
<p>去吧！皮卡丘！<br>小时候拥有一台任天堂是多少熊孩子的梦想，每个夜晚被窝里透出的微弱光线，把小小的童年带入另一个世界，家门口的鸟和狗，森林里的虫和瀑布，山洞里的超音蝠，第一次钓鱼，第一次骑自行车，踩过一片片草地，走过一个个城市，一路冒险，飞天潜水，攀瀑碎岩，所向披靡。<br>每天早上醒来，都恍如出门冒险的那天清晨~ 那是属于80后最珍贵的记忆~</p>
<div style="text-align: right;"> - 前言</div>

</blockquote>
<p><img src="../images/pokemon/code.png" alt="qrcode"></p>
<h2 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h2><h3 id="一、确定功能需求"><a href="#一、确定功能需求" class="headerlink" title="一、确定功能需求"></a>一、确定功能需求</h3><h4 id="第一阶段"><a href="#第一阶段" class="headerlink" title="第一阶段"></a>第一阶段</h4><p>1、用户体系<br>2、背包<br>3、图鉴<br>4、人物定位<br>5、精灵分布<br>6、精灵捕捉<br>7、排行榜<br>8、移动随机事件<br>9、新手引导</p>
<h4 id="第二阶段"><a href="#第二阶段" class="headerlink" title="第二阶段"></a>第二阶段</h4><p>1、地图增加道馆挑战<br>2、日常任务系统</p>
<h4 id="第三阶段"><a href="#第三阶段" class="headerlink" title="第三阶段"></a>第三阶段</h4><p>1、精灵交易<br>2、玩家对战<br>3、AR捕捉场景</p>
<h3 id="二、开放地图选择"><a href="#二、开放地图选择" class="headerlink" title="二、开放地图选择"></a>二、开放地图选择</h3><table>
<thead>
<tr>
<th>功能 / 厂商</th>
<th>百度地图</th>
<th>腾讯地图</th>
<th>高德地图</th>
</tr>
</thead>
<tbody>
<tr>
<td>自定义皮肤</td>
<td>支持</td>
<td>不支持</td>
<td>支持</td>
</tr>
<tr>
<td>实时定位</td>
<td>不支持</td>
<td>支持</td>
<td>支持</td>
</tr>
<tr>
<td>开发文档</td>
<td>差</td>
<td>一般</td>
<td>友好</td>
</tr>
</tbody>
</table>
<p>对比三个地图厂商，我们选择高德地图进行二次开发</p>
<h3 id="三、申请高德地图SDK"><a href="#三、申请高德地图SDK" class="headerlink" title="三、申请高德地图SDK"></a>三、申请高德地图SDK</h3><p>登录<a href="http://lbs.amap.com/" target="_blank" rel="external">http://lbs.amap.com/</a><br>控制台-应用管理-创建新应用-添加新KEY</p>
<h3 id="四、接入微信授权"><a href="#四、接入微信授权" class="headerlink" title="四、接入微信授权"></a>四、接入微信授权</h3><p>具体参考微信公众平台开发者文档<br><a href="https://mp.weixin.qq.com/wiki?t=resource/res_main&amp;id=mp1421140842" target="_blank" rel="external">https://mp.weixin.qq.com/wiki?t=resource/res_main&amp;id=mp1421140842</a></p>
<h3 id="五、服务端接口"><a href="#五、服务端接口" class="headerlink" title="五、服务端接口"></a>五、服务端接口</h3><p>我们需要一些接口来保存用户数据，所以需要找一个服务端的同学配合完成几个简单的接口：</p>
<ol>
<li><code>api/login</code> 判断登录状态，获取用户基本信息</li>
<li><code>api/getGlassPokemon</code> 获取草地精灵</li>
<li><code>api/getMyPokemon</code> 获取背包精灵</li>
<li><code>api/catchPokemon</code> 捕捉精灵</li>
<li><code>api/getRank</code> 获取排行榜信息</li>
</ol>
<h3 id="六、素材准备"><a href="#六、素材准备" class="headerlink" title="六、素材准备"></a>六、素材准备</h3><p>1、简单设计一下主界面 UI，确定每个功能布局，和地图的配色方案</p>
<p><img src="../images/pokemon/1.png" alt="clipboard.png"></p>
<p>2、准备150只精灵的素材图片（大小各一套）</p>
<p><img src="../images/pokemon/2.png" alt="clipboard.png"></p>
<p><img src="../images/pokemon/3.png" alt="clipboard.png"></p>
<h2 id="现在开始"><a href="#现在开始" class="headerlink" title="现在开始"></a>现在开始</h2><h3 id="一、接入高德地图"><a href="#一、接入高德地图" class="headerlink" title="一、接入高德地图"></a>一、接入高德地图</h3><p>在 <code>&lt;head&gt;&lt;/head&gt;</code> 中引入高德地图 js-sdk</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"http://webapi.amap.com/maps?v=1.3&amp;key=464e2c3addc64c5894994afe0bbdca21"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></div></pre></td></tr></table></figure>
<blockquote>
<p>key的值为高德地图开发者中心创建应用后获得的key</p>
</blockquote>
<p>在 <code>html</code> 中创建地图容器</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"gomap"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></div></pre></td></tr></table></figure>
<p>在 js 中初始化地图</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> gomap;</div><div class="line">gomap = <span class="keyword">new</span> AMap.Map(<span class="string">'gomap'</span>, &#123;</div><div class="line">    zoomEnable : <span class="literal">false</span>,              <span class="comment">//不允许缩放</span></div><div class="line">    zoom:<span class="number">18</span>,                         <span class="comment">//默认缩放等级18</span></div><div class="line">    center: [<span class="number">118.18088</span>, <span class="number">24.4896</span>],    <span class="comment">//初始定位坐标</span></div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>至此地图已经接入完成 <a href="https://www.guowc.cc/go/demo1.html" target="_blank" rel="external">查看DEMO</a></p>
<p><img src="../images/pokemon/4.png" alt="clipboard.png"></p>
<h3 id="二、地图美化"><a href="#二、地图美化" class="headerlink" title="二、地图美化"></a>二、地图美化</h3><p>默认的地图样式不能满足我们的需求，高德地图提供了地图皮肤编辑器：<a href="http://lbs.amap.com/dev/mapstyle/index" target="_blank" rel="external">高德地图皮肤编辑器</a></p>
<p><img src="../images/pokemon/5.png" alt="clipboard.png"></p>
<p>在编辑器中修改道路，陆地，建筑，水域等颜色，同时在配置中修改每种标志物显示情况，简化地图。<br>编辑完成后点击发布，获得地图样式ID：<code>e6fa21422698f8a28585158d9d075f1d</code><br>在地图初始化中引入地图样式即可：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> gomap = <span class="keyword">new</span> AMap.Map(<span class="string">'gomap'</span>, &#123;</div><div class="line">    zoomEnable : <span class="literal">false</span>,</div><div class="line">    zoom:<span class="number">18</span>,</div><div class="line">    center: [<span class="number">118.18088</span>, <span class="number">24.4896</span>],</div><div class="line">    mapStyle : <span class="string">'amap://styles/e6fa21422698f8a28585158d9d075f1d'</span></div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p><a href="https://www.guowc.cc/go/demo2.html" target="_blank" rel="external">查看DEMO</a></p>
<p><img src="../images/pokemon/6.png" alt="clipboard.png"></p>
<p>这样看起来就有点游戏的样子了</p>
<h3 id="三、地图定位"><a href="#三、地图定位" class="headerlink" title="三、地图定位"></a>三、地图定位</h3><p>我们需要把地图和主角定位在当前位置，并且在移动时实时更新定位，这就需要借助 <code>AMap</code> 的 <code>geolocation</code> 插件</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">gomap.plugin(<span class="string">'AMap.Geolocation'</span>,<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">    <span class="keyword">var</span> geo = <span class="keyword">new</span> AMap.Geolocation(&#123;</div><div class="line">        showButton: <span class="literal">false</span>,</div><div class="line">        showCircle: <span class="literal">false</span>,</div><div class="line">        showMarker : <span class="literal">true</span>, <span class="comment">//显示定位图标</span></div><div class="line">        markerOptions : &#123;</div><div class="line">            content : <span class="string">'&lt;div class="Symbol hero"&gt;&lt;/div&gt;'</span>, <span class="comment">//设置marker自定义节点内容</span></div><div class="line">        &#125;</div><div class="line">    &#125;);</div><div class="line">    gomap.addControl(geo);</div><div class="line">    geo.watchPosition(); <span class="comment">//实时获取定位</span></div><div class="line">    AMap.event.addListener(geolocation, <span class="string">'complete'</span>, onComplete); <span class="comment">//返回定位成功信息</span></div><div class="line">    AMap.event.addListener(geolocation, <span class="string">'error'</span>, onError); <span class="comment">//返回定位出错信息</span></div><div class="line">&#125;)</div></pre></td></tr></table></figure>
<p><img src="../images/pokemon/7.png" alt="clipboard.png"></p>
<p>小智一个人站在地图上有点孤单，我们给他加一个光环放大的效果，看起来像是在发出检测信号：</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="selector-class">.Symbol</span><span class="selector-class">.hero</span><span class="selector-pseudo">:after</span>&#123;</div><div class="line">    <span class="attribute">-webkit-animation</span>:heroWave <span class="number">2s</span> ease infinite;</div><div class="line">    <span class="attribute">background</span>:<span class="built_in">rgba</span>(255,255,181,0.1);</div><div class="line">    <span class="attribute">content</span>:<span class="string">''</span>;</div><div class="line">    <span class="attribute">width</span>:<span class="number">100px</span>;</div><div class="line">    <span class="attribute">height</span>:<span class="number">100px</span>;</div><div class="line">    <span class="attribute">display</span>:block;</div><div class="line">    <span class="attribute">position</span>:absolute;</div><div class="line">    <span class="attribute">left</span>:-<span class="number">30px</span>;</div><div class="line">    <span class="attribute">top</span>:-<span class="number">30px</span>;</div><div class="line">    <span class="attribute">border-radius</span>:<span class="number">100%</span>;</div><div class="line">    <span class="attribute">box-shadow</span>:<span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">1px</span> <span class="built_in">rgba</span>(255,255,181,0.7);</div><div class="line">    <span class="attribute">opacity</span>:<span class="number">0.7</span>;</div><div class="line">&#125;</div><div class="line">@-<span class="keyword">webkit</span>-<span class="keyword">keyframes</span> heroWave&#123;</div><div class="line">    0%&#123; <span class="attribute">-webkit-transform</span>:<span class="built_in">scale</span>(0.2);<span class="attribute">opacity</span>:<span class="number">0</span>&#125;</div><div class="line">    50%&#123; <span class="attribute">opacity</span>:<span class="number">1</span>&#125;</div><div class="line">    100%&#123; <span class="attribute">-webkit-transform</span>:<span class="built_in">scale</span>(1);<span class="attribute">opacity</span>:<span class="number">0</span>&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><img src="../images/pokemon/8.gif" alt="图片描述"></p>
<p><a href="https://www.guowc.cc/go/demo3.html" target="_blank" rel="external">查看DEMO</a></p>
<h3 id="四、罗盘"><a href="#四、罗盘" class="headerlink" title="四、罗盘"></a>四、罗盘</h3><p>有了定位，我们还需要知道自己移动的方向，方便接近目标，所以我们在界面右上角放置了一个虚拟罗盘</p>
<p><img src="../images/pokemon/9.png" alt="clipboard.png"></p>
<p>通过监听 HTML5 的 <code>deviceorientation</code> 获取指南针角度信息，改变罗盘旋转方向：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> (<span class="built_in">window</span>.DeviceOrientationEvent) &#123;</div><div class="line">    <span class="built_in">window</span>.addEventListener(<span class="string">"deviceorientation"</span>, <span class="function"><span class="keyword">function</span>(<span class="params">event</span>)</span>&#123;</div><div class="line">        <span class="keyword">var</span> dir =  event.webkitCompassHeading;</div><div class="line">        $(<span class="string">"#J_pin"</span>).css(<span class="string">"-webkit-transform"</span>,<span class="string">'rotate('</span>+ (<span class="number">360</span>-dir) +<span class="string">'deg)'</span>);</div><div class="line">    &#125;, <span class="literal">false</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><a href="https://www.guowc.cc/go/demo4.html" target="_blank" rel="external">查看DEMO</a> (罗盘只在移动端生效，扫码查看)</p>
<p><img src="../images/pokemon/10.png" alt="clipboard.png"></p>
<h3 id="五、精灵数据"><a href="#五、精灵数据" class="headerlink" title="五、精灵数据"></a>五、精灵数据</h3><p>由于精灵的编号，属性，星级等数据是固定的，我们需要在前端创建一个保存精灵图鉴数据的 JSON 文件，以减少服务端返回数据的复杂度，只需通过编号，在图鉴中索引对应精灵的相关数据：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> Pokedex = [</div><div class="line">    &#123;</div><div class="line">        <span class="string">'number'</span>:<span class="string">'001'</span>,</div><div class="line">        <span class="string">'name'</span> :<span class="string">'妙蛙种子'</span>,</div><div class="line">        <span class="string">'name_jp'</span> : <span class="string">'フシギダネ'</span>,</div><div class="line">        <span class="string">'name_en'</span> : <span class="string">'Bulbasaur'</span>,</div><div class="line">        <span class="string">'properties'</span> : [<span class="string">'草'</span>,<span class="string">'毒'</span>],</div><div class="line">        <span class="string">'star'</span> : <span class="number">4</span>,</div><div class="line">    &#125;,</div><div class="line">    &#123;</div><div class="line">        <span class="string">'number'</span>:<span class="string">'002'</span>,</div><div class="line">        <span class="string">'name'</span> :<span class="string">'妙蛙草'</span>,</div><div class="line">        <span class="string">'name_jp'</span> : <span class="string">'フシギソウ'</span>,</div><div class="line">        <span class="string">'name_en'</span> : <span class="string">'Ivysaur'</span>,</div><div class="line">        <span class="string">'properties'</span> : [<span class="string">'草'</span>,<span class="string">'毒'</span>],</div><div class="line">        <span class="string">'star'</span> : <span class="number">4</span>,</div><div class="line">    &#125;,</div><div class="line">    ...</div><div class="line">];</div><div class="line"><span class="comment">//精灵属性颜色配置</span></div><div class="line"><span class="keyword">var</span> Pokedexcolor = &#123;</div><div class="line">    <span class="string">'草'</span> : <span class="string">'#1ba50e,#2ec920'</span>,</div><div class="line">    <span class="string">'冰'</span> : <span class="string">'#13c6db,#57e9ff'</span>,</div><div class="line">    <span class="string">'超能力'</span> :<span class="string">'#dd045b,#f7478d'</span>,</div><div class="line">    <span class="string">'虫'</span> : <span class="string">'#889610,#b5b214'</span>,</div><div class="line">    <span class="string">'地面'</span> : <span class="string">'#af8a19,#d8b343'</span>,</div><div class="line">    <span class="string">'电'</span> : <span class="string">'#b28200,#ffd621'</span>,</div><div class="line">    <span class="string">'毒'</span> : <span class="string">'#752464,#9e448c'</span>,</div><div class="line">    <span class="string">'飞行'</span> : <span class="string">'#4381ff,#72aefc'</span>,</div><div class="line">    <span class="string">'钢'</span> : <span class="string">'#6d6d8a,#aaaabb'</span>,</div><div class="line">    <span class="string">'格斗'</span> : <span class="string">'#902918,#bb5544'</span>,</div><div class="line">    <span class="string">'火'</span> : <span class="string">'#c72500,#f05526'</span>,</div><div class="line">    <span class="string">'龙'</span> : <span class="string">'#2b1aa6,#7766ee'</span>,</div><div class="line">    <span class="string">'水'</span> : <span class="string">'#2b1aa6,#3088e1'</span>,</div><div class="line">    <span class="string">'岩石'</span> : <span class="string">'#907d2f,#a89755'</span>,</div><div class="line">    <span class="string">'一般'</span> : <span class="string">'#969685,#bbbbaa'</span>,</div><div class="line">    <span class="string">'幽灵'</span> : <span class="string">'#3d3d7c,#5f52a7'</span>,</div><div class="line">    <span class="string">'妖精'</span> : <span class="string">'#3d3d7c,#5f52a7'</span>,</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p>编号001精灵对应的小图地址为 <code>&#39;images/pokemon/001.png&#39;</code>，大图地址为 <code>&#39;images/pokemon_big/001.png&#39;</code></p>
</blockquote>
<h3 id="六、在地图上添加精灵"><a href="#六、在地图上添加精灵" class="headerlink" title="六、在地图上添加精灵"></a>六、在地图上添加精灵</h3><p>主角有了，但是地图空空如也，现在我们需要在主角周围生成一些随机的精灵，通过调用 <code>getGlassPokemon</code> 接口，传递当前位置坐标，服务端在坐标半径1公里内生成一定个数的精灵，前端通过返回的坐标和精灵编号将对应精灵添加到地图上。</p>
<blockquote>
<p>由于后续接口需要验证微信授权信息，为了便于DEMO查看请先访问一次模拟登陆接口：<a href="http://www.guowc.cc/api/sysUser/login?openid=o3aw6v1QLA6R7B0w6vPBfL9Ti8Mw" target="_blank" rel="external">http://www.guowc.cc/api/sysUser/login?openid=o3aw6v1QLA6R7B0w6vPBfL9Ti8Mw</a></p>
</blockquote>
<p><code>getGlassPokemon</code> 接口返回数据格式：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    data : &#123;</div><div class="line">        &#123;</div><div class="line">            id : <span class="number">231</span>, <span class="comment">//精灵唯一标识，用于捕捉成功后从数据库中精准删除地图对应精灵</span></div><div class="line">            number: <span class="string">"77"</span>, <span class="comment">//精灵编号，用于图鉴中获取更多精灵信息</span></div><div class="line">            lng : <span class="number">118.094561807441</span>, <span class="comment">//精灵经度</span></div><div class="line">            lat : <span class="number">24.4805797983452</span>, <span class="comment">//精灵纬度</span></div><div class="line">        &#125;,</div><div class="line">        ...</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>首先在前面的geolocation插件中调用 <code>getCurrentPosition()</code> 方法，获取一次初始定位坐标，将坐标传给 <code>getPokemons</code> 接口拉取草地精灵数据：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> self = <span class="keyword">this</span></div><div class="line">gomap.plugin(<span class="string">'AMap.Geolocation'</span>,<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">    <span class="keyword">var</span> geo = <span class="keyword">new</span> AMap.Geolocation(&#123;</div><div class="line">        ...</div><div class="line">    &#125;);</div><div class="line">    ...</div><div class="line">    <span class="comment">//首次定位</span></div><div class="line">    geo.getCurrentPosition(<span class="function"><span class="keyword">function</span>(<span class="params"> status, result </span>)</span>&#123;</div><div class="line">        heroPoint.lng = result.position.lng;</div><div class="line">        heroPoint.lat = result.position.lat;</div><div class="line">        self.getPokemon(heroPoint)</div><div class="line">    &#125;);</div><div class="line">&#125;)</div></pre></td></tr></table></figure>
<p>请求接口数据：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> getPokemon = <span class="function"><span class="keyword">function</span> (<span class="params">point</span>) </span>&#123;</div><div class="line">    <span class="keyword">var</span> self = <span class="keyword">this</span></div><div class="line">    Method.fetch(Api.getGlassPokemons,&#123; <span class="attr">lng</span>:point.lng,<span class="attr">lat</span>:point.lat &#125;,<span class="function"><span class="keyword">function</span>(<span class="params">data</span>)</span>&#123;</div><div class="line">        <span class="keyword">var</span> res = data.data;</div><div class="line">        <span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; res.length; i++)&#123;</div><div class="line">            self.addPokemon(res[i]);</div><div class="line">        &#125;</div><div class="line">    &#125;);</div><div class="line">&#125;,</div></pre></td></tr></table></figure>
<blockquote>
<p>Method.fetch为封装的ajax方法，只贴出关键流程代码，具体详见DEMO</p>
</blockquote>
<p>获取到数据后，循环调用 <code>addPokemon</code> 方法，将精灵添加到地图上：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> addPokemon = <span class="function"><span class="keyword">function</span> (<span class="params">data</span>) </span>&#123;</div><div class="line">    <span class="keyword">var</span> pid = Method.getPid(data.number); <span class="comment">//获取精灵编号（格式化'12'=&gt;'012'）</span></div><div class="line">    <span class="keyword">var</span> marker =  <span class="keyword">new</span> AMap.Marker(&#123;</div><div class="line">        map: Common.gomap,</div><div class="line">		position: [data.position_x, data.position_y],</div><div class="line">        icon: <span class="keyword">new</span> AMap.Icon(&#123;</div><div class="line">            size: <span class="keyword">new</span> AMap.Size(<span class="number">40</span>, <span class="number">40</span>),</div><div class="line">            imageSize : <span class="keyword">new</span> AMap.Size(<span class="number">40</span>, <span class="number">40</span>),</div><div class="line">            image: <span class="string">"images/pokemon/PM_icon_"</span>+ pid +<span class="string">".png"</span>,</div><div class="line">        &#125;),</div><div class="line">    &#125;);</div><div class="line">&#125;,</div></pre></td></tr></table></figure>
<p><a href="https://www.guowc.cc/go/demo5.html" target="_blank" rel="external">查看DEMO</a></p>
<p><img src="../images/pokemon/11.png" alt="clipboard.png"></p>
<p>现在我们就能在地图上看到精灵了～</p>
<h3 id="七、获取背包精灵"><a href="#七、获取背包精灵" class="headerlink" title="七、获取背包精灵"></a>七、获取背包精灵</h3><p>这一步我们先把已捕捉到的精灵列表保存起来，以便后续使用：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> getMyPokemons = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">    Method.fetch(API.getMyPokemons,&#123;&#125;,<span class="function"><span class="keyword">function</span>(<span class="params">data</span>)</span>&#123;</div><div class="line">        <span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span> ;i &lt; data.data.length; i++)&#123;</div><div class="line">            State.bag.push(Method.getPid(data.data[i].number));   <span class="comment">//将已获得精灵编号保存在全局State.bag数组中</span></div><div class="line">        &#125;</div><div class="line">    &#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="八、精灵收集"><a href="#八、精灵收集" class="headerlink" title="八、精灵收集"></a>八、精灵收集</h3><h4 id="操作优化"><a href="#操作优化" class="headerlink" title="操作优化"></a>操作优化</h4><p>精灵收集是整个游戏的核心功能，原版pokemonGo精灵捕捉过程为AR实景捕捉形式，我们把精灵的捕捉形式简化了，保留街机时代的像素风格。最早在实现这个功能时，采用的策略是当玩家坐标与地图精灵小于一定距离时，自动进入精灵捕捉场景，这种方式存在几个问题：</p>
<ol>
<li>用户位置发生变化时，需要不断计算用户坐标与地图上所有精灵的距离，计算量较大</li>
<li>可能存在同时与两个精灵距离符合捕捉条件，而一次只能捕捉一只精灵</li>
<li>用户如果不移动，基本很难捕捉到精灵</li>
</ol>
<p>优化后将捕捉规则修改为：直接点击地图精灵即可捕捉，半径500米外提示用户需走进范围才能捕捉。优化后的方案降低了捕捉门槛，也鼓励用户走动去发现和捕捉更多精灵。</p>
<h4 id="数据传递"><a href="#数据传递" class="headerlink" title="数据传递"></a>数据传递</h4><p>上一步的 <code>addPokemon</code> 方法中，我们已经向地图中添加了精灵点标记（marker），但此时地图上的精灵唯一区分只是图片不同而已，我们还需为每个 marker 绑定对应的精灵信息，并为每个 marker 绑定点击事件，下面完善一下 <code>addPokemon</code> 方法：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> addPokemon = <span class="function"><span class="keyword">function</span> (<span class="params">data</span>) </span>&#123;</div><div class="line">    <span class="keyword">var</span> self = <span class="keyword">this</span>;</div><div class="line">    <span class="keyword">var</span> nid = <span class="built_in">parseInt</span>(data.number);</div><div class="line">    <span class="keyword">var</span> pid = Method.getPid(data.number); <span class="comment">//获取精灵编号（格式化'12'=&gt;'012'）;</span></div><div class="line">    <span class="keyword">var</span> id = data.id;</div><div class="line">    <span class="keyword">var</span> marker =  <span class="keyword">new</span> AMap.Marker(&#123;</div><div class="line">        map: Common.gomap,</div><div class="line">		position: [data.position_x, data.position_y],</div><div class="line">        icon: <span class="keyword">new</span> AMap.Icon(&#123;</div><div class="line">            size: <span class="keyword">new</span> AMap.Size(<span class="number">40</span>, <span class="number">40</span>),</div><div class="line">            imageSize : <span class="keyword">new</span> AMap.Size(<span class="number">40</span>, <span class="number">40</span>),</div><div class="line">            image: <span class="string">"images/pokemon/PM_icon_"</span>+ pid +<span class="string">".png"</span>,</div><div class="line">        &#125;),</div><div class="line">        extData : &#123;</div><div class="line">            nid : nid,</div><div class="line">            id  : id,</div><div class="line">        &#125;</div><div class="line">    &#125;);</div><div class="line">    marker.on(<span class="string">'click'</span>,<span class="function"><span class="keyword">function</span>(<span class="params">e</span>)</span>&#123;</div><div class="line">        self.clickPokemon(e)</div><div class="line">    &#125;)</div><div class="line">&#125;,</div></pre></td></tr></table></figure>
<p>由于地图上显示精灵图标过小，无法展示更多信息，所以我们在点击精灵后，没有直接进入战斗，先弹出对应精灵的卡牌：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"> <span class="function"><span class="keyword">function</span> <span class="title">clickPokemon</span>(<span class="params">e</span>)</span>&#123;</div><div class="line">    <span class="keyword">var</span> self = <span class="keyword">this</span>;</div><div class="line">    <span class="keyword">var</span> data = e.target.getExtData();</div><div class="line">    self.initPokecard(data.nid,e.target);</div><div class="line">&#125;,</div></pre></td></tr></table></figure>
<p><img src="../images/pokemon/12.gif" alt="图片描述"></p>
<p>初始化卡牌弹窗：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"Modal pokedex"</span> <span class="attr">id</span>=<span class="string">"js-modal-pokedex"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"card"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"namebox"</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">p</span> <span class="attr">class</span>=<span class="string">"name_cn"</span>&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">p</span> <span class="attr">class</span>=<span class="string">"name_jp"</span>&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"pokebox"</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">img</span> <span class="attr">class</span>=<span class="string">"pokeimg"</span> <span class="attr">src</span>=<span class="string">""</span> <span class="attr">alt</span>=<span class="string">""</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"Widget stars"</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"star"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"propbox"</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"num"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"prop"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">p</span> <span class="attr">class</span>=<span class="string">"Widget timer tips"</span>&gt;</span><span class="tag">&lt;<span class="name">b</span> <span class="attr">class</span>=<span class="string">"t"</span>&gt;</span>TIPS <span class="tag">&lt;/<span class="name">b</span>&gt;</span>捕捉半径<span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"t"</span>&gt;</span>500<span class="tag">&lt;/<span class="name">span</span>&gt;</span>米 当前距离<span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"t dist"</span>&gt;</span>0<span class="tag">&lt;/<span class="name">span</span>&gt;</span>米<span class="tag">&lt;/<span class="name">p</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">span</span> <span class="attr">id</span>=<span class="string">"js-btn-catch"</span> <span class="attr">class</span>=<span class="string">"catchbtn"</span>&gt;</span>捕捉<span class="tag">&lt;/<span class="name">span</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></div></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> initPokecard = <span class="function"><span class="keyword">function</span>(<span class="params">nid, target</span>) </span>&#123;</div><div class="line">    <span class="keyword">var</span> $card = Element.$pokedex，</div><div class="line">        $<span class="keyword">catch</span> = Element.$<span class="keyword">catch</span>;</div><div class="line">    <span class="keyword">var</span> data = Pokedex[nid - <span class="number">1</span>];   <span class="comment">//从图鉴JSON中获取对应精灵详细图鉴数据</span></div><div class="line">    <span class="keyword">var</span> props = <span class="string">''</span>, dist = <span class="number">0</span>;</div><div class="line">    <span class="keyword">var</span> imgUrl = <span class="string">'images/pokemon_big/PM_animation_'</span>+ data.number +<span class="string">'.png'</span>;</div><div class="line"></div><div class="line">    <span class="comment">//拼接属性节点</span></div><div class="line">    <span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>; i&lt; data.properties.length; i++)&#123;</div><div class="line">        <span class="keyword">var</span> color = Pokedexcolor[data.properties[i]].split(<span class="string">','</span>);</div><div class="line">        props += <span class="string">'&lt;div class="item" style="background:'</span>+ color[<span class="number">1</span>] +<span class="string">';border-color:'</span>+ color[<span class="number">0</span>] +<span class="string">'"&gt;'</span>+ data.properties[i] +<span class="string">'&lt;/div&gt;'</span>;</div><div class="line">    &#125;</div><div class="line">    $card.find(<span class="string">'.name_cn'</span>).text(data.name);  <span class="comment">//精灵中文名</span></div><div class="line">    $card.find(<span class="string">'.name_jp'</span>).text(data.name_jp + data.name_en);  <span class="comment">//精灵外文名</span></div><div class="line">    $card.find(<span class="string">'.star'</span>)[<span class="number">0</span>].className = <span class="string">'star star_'</span> + data.star;   <span class="comment">//精灵星级</span></div><div class="line">    $card.find(<span class="string">'.num'</span>).text(<span class="string">'No.'</span> + data.number);  <span class="comment">//精灵编号</span></div><div class="line">    $card.find(<span class="string">'.prop'</span>).html(props);   <span class="comment">//精灵属性</span></div><div class="line">    <span class="comment">//预加载精灵大图</span></div><div class="line">    $card.find(<span class="string">'.pokebox'</span>).removeClass(<span class="string">'loaded'</span>);</div><div class="line">    Method.loadImg(imgUrl, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">        $card.find(<span class="string">'.pokeimg'</span>).attr(<span class="string">'src'</span>,imgUrl);</div><div class="line">        $card.find(<span class="string">'.pokebox'</span>).addClass(<span class="string">'loaded'</span>);</div><div class="line">    &#125;);</div><div class="line">    $card.addClass(<span class="string">'show'</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>到这里就完成了精灵卡片的初始化（背包图鉴点击精灵小图共用这个弹窗），然而卡片只带有固定数据，需要跟单纯的图鉴查看器做区分，我们在卡片下方加上操作区，操作区有3种状态：精灵可捕捉，精灵已获得，精灵超出捕捉半径</p>
<p><img src="../images/pokemon/13.png" alt="clipboard.png"></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> initPokecard = <span class="function"><span class="keyword">function</span>(<span class="params">nid, target</span>) </span>&#123;</div><div class="line">    ...</div><div class="line">    <span class="comment">//判断点击精灵行为来自地图还是图鉴</span></div><div class="line">    <span class="keyword">if</span>(target) &#123;</div><div class="line">        <span class="keyword">var</span> pa = target.getPosition(),</div><div class="line">            pb = [State.heroPoint.lng,State.heroPoint.lat];</div><div class="line">        <span class="keyword">var</span> dist = <span class="built_in">parseInt</span>(pa.distance(pb));  <span class="comment">//计算主角与点击精灵距离</span></div><div class="line"></div><div class="line">        $card.addClass(<span class="string">'catch'</span>);</div><div class="line">        $card.off().on(<span class="string">'touchend'</span>,<span class="function"><span class="keyword">function</span>(<span class="params">e</span>)</span>&#123;</div><div class="line">            $(<span class="keyword">this</span>).removeClass(<span class="string">'show'</span>);</div><div class="line">            e.preventDefault();</div><div class="line">        &#125;)</div><div class="line">        <span class="keyword">if</span>( dist &lt; <span class="number">500</span> ) &#123;</div><div class="line">            $card.find(<span class="string">'.tips'</span>).hide();</div><div class="line">            <span class="keyword">if</span>(State.bag.indexOf(data.number) != <span class="number">-1</span>)&#123;</div><div class="line">                $<span class="keyword">catch</span>.removeClass().addClass(<span class="string">'ownbtn'</span>).text(<span class="string">'已获得'</span>);</div><div class="line">            &#125;<span class="keyword">else</span>&#123;</div><div class="line">                $<span class="keyword">catch</span>.removeClass().addClass(<span class="string">'catchbtn'</span>).text(<span class="string">'捕捉'</span>);</div><div class="line">            &#125;</div><div class="line">        &#125;<span class="keyword">else</span>&#123;</div><div class="line">            $card.find(<span class="string">'.dist'</span>).text(dist);</div><div class="line">            $card.find(<span class="string">'.tips'</span>).show();</div><div class="line">            $<span class="keyword">catch</span>.removeClass().addClass(<span class="string">'overbtn'</span>).text(<span class="string">'走近点啊亲'</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;<span class="keyword">else</span>&#123;</div><div class="line">        $card.removeClass(<span class="string">'catch'</span>);</div><div class="line">        $card.find(<span class="string">'.tips'</span>).hide();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><img src="../images/pokemon/14.png" alt="clipboard.png"></p>
<p><img src="../images/pokemon/15.png" alt="clipboard.png"></p>
<p><a href="https://www.guowc.cc/go/demo6.html" target="_blank" rel="external">查看DEMO</a></p>
<h3 id="九、精灵捕捉场景"><a href="#九、精灵捕捉场景" class="headerlink" title="九、精灵捕捉场景"></a>九、精灵捕捉场景</h3><p>首先为卡片下方的捕捉按钮绑定事件，将点击的精灵数据传递到 <code>meetPokemon</code> 方法中（初始化精灵捕捉场景方法）：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> initPokecard = <span class="function"><span class="keyword">function</span>(<span class="params">nid, target</span>) </span>&#123;</div><div class="line">    ...</div><div class="line">    <span class="keyword">if</span>(target) &#123;</div><div class="line">        <span class="keyword">var</span> ext = target.getExtData()</div><div class="line">        $<span class="keyword">catch</span>.off();  <span class="comment">//解除捕捉按钮绑定事件</span></div><div class="line">        ...</div><div class="line">        <span class="keyword">if</span>( dist &lt; <span class="number">500</span> )&#123;</div><div class="line">            <span class="keyword">if</span>(State.bag.indexOf(<span class="string">'data.number'</span>) != <span class="number">-1</span>)&#123;</div><div class="line">                ...</div><div class="line">            &#125;<span class="keyword">else</span>&#123;</div><div class="line">                $<span class="keyword">catch</span>.on(<span class="string">'touchend'</span>, self.meetPokemon(ext.nid,ext.id));</div><div class="line">                target.setMap(<span class="literal">null</span>);  <span class="comment">//开始捕捉后将地图上对应小精灵移除（捕捉成功or失败小精灵都会消失）</span></div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;<span class="keyword">else</span>&#123;</div><div class="line"></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>然后初始化捕捉场景：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> meetPokemon = <span class="function"><span class="keyword">function</span>(<span class="params">nid,id</span>)</span>&#123;</div><div class="line">    Element.$modal.removeClass(<span class="string">'show'</span>);</div><div class="line">    Element.$body.addClass(<span class="string">'State catching'</span>);  <span class="comment">//进入捕捉场景需要控制界面多处UI，所以把状态class放到body上</span></div><div class="line">    Element.$catchBox.find(<span class="string">'.texture'</span>).attr(<span class="string">'src'</span>,<span class="string">'images/pokemon_big/PM_animation_'</span> + Pokedex[nid].number + <span class="string">'.png'</span>);</div><div class="line">    Element.$catchBox.find(<span class="string">'.pname'</span>).text(Pokedex[nid].name);</div><div class="line">    Element.$catchBox.find(<span class="string">'.star'</span>)[<span class="number">0</span>].className = <span class="string">'star star_'</span> + Pokedex[nid].star;</div><div class="line">&#125;,</div></pre></td></tr></table></figure>
<p><img src="../images/pokemon/16.gif" alt="图片描述"></p>
<p><a href="https://www.guowc.cc/go/demo7.html" target="_blank" rel="external">查看DEMO</a></p>
<h3 id="十、去吧精灵球！"><a href="#十、去吧精灵球！" class="headerlink" title="十、去吧精灵球！"></a>十、去吧精灵球！</h3><p>现在点击丢出精灵球开始捕捉精灵，首先在 <code>meetPokemon</code> 中绑定精灵球的点击事件：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> meetPokemon = <span class="function"><span class="keyword">function</span>(<span class="params">nid,id</span>)</span>&#123;</div><div class="line">    ...</div><div class="line">    Element.$catchBox.find(<span class="string">'.ballbox'</span>).off().on(<span class="string">'touchend'</span>,<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">        self.catchPokemon(nid,id)</div><div class="line">    &#125;)</div><div class="line">&#125;,</div></pre></td></tr></table></figure>
<p>接下来实现 <code>catchPokemon</code> 方法：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> catchPokemon = <span class="function"><span class="keyword">function</span>(<span class="params">nid,id</span>)</span>&#123;</div><div class="line">    <span class="keyword">var</span> self = <span class="keyword">this</span>;</div><div class="line">    <span class="keyword">var</span> name = Pokedex[nid].name,</div><div class="line">        pid = Pokedex[nid].number,</div><div class="line">        star = Pokedex[nid].star,</div><div class="line">        rate = <span class="number">0.8</span> -  star / <span class="number">10</span>;   <span class="comment">//根据星级决定捕捉成功概率</span></div><div class="line"></div><div class="line">    <span class="keyword">if</span>(State.catching) <span class="keyword">return</span>;</div><div class="line"></div><div class="line">    <span class="keyword">if</span>(Method.random(rate))&#123;</div><div class="line">        <span class="comment">//捕捉成功</span></div><div class="line">        Element.$catchBox.addClass(<span class="string">'catchwin'</span>);    <span class="comment">//在catchbox上增加catchwin控制捕捉成功动画（动画具体实现参照DEMO）</span></div><div class="line">        Method.fetch(API.catchPokemon,&#123; <span class="attr">id</span> : id &#125;,<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">            <span class="built_in">console</span>.log(<span class="string">'捕捉成功！'</span>)   <span class="comment">//向服务端发送捕捉成功请求，移除getGlassPokemon返回的对应位置精灵，同时加入用户背包</span></div><div class="line">        &#125;);</div><div class="line">        setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">            <span class="comment">//动画播放结束后调用捕捉成功弹窗</span></div><div class="line">            self.awardBox(<span class="string">'images/pokemon_big/PM_animation_'</span> + pid + <span class="string">'.png'</span>,name,<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">                <span class="comment">//弹窗关闭后回到主界面</span></div><div class="line">                $body.removeClass();</div><div class="line">                Element.$catchBox.removeClass(<span class="string">'catchwin'</span>);</div><div class="line">                State.catching = <span class="literal">false</span>;</div><div class="line">            &#125;);</div><div class="line">        &#125;,<span class="number">3200</span>);</div><div class="line">    &#125;<span class="keyword">else</span>&#123;</div><div class="line">        <span class="comment">//捕捉失败</span></div><div class="line">        Element.$catchBox.addClass(<span class="string">'catchfail'</span>);  <span class="comment">//在catchbox上增加catchfail控制捕捉失败动画</span></div><div class="line">        Method.fetch(API.catchPokemon,&#123; <span class="attr">id</span> : id , <span class="attr">flag</span> : <span class="literal">true</span>&#125;,<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">            <span class="built_in">console</span>.log(<span class="string">'捕捉失败！'</span>)   <span class="comment">//向服务端发送捕捉失败请求，仅移除getGlassPokemon返回的对应位置精灵</span></div><div class="line">        &#125;);</div><div class="line">        setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">            <span class="comment">//动画播放失败后调用捕捉失败弹窗</span></div><div class="line">            self.alertBox(name + <span class="string">' 逃跑了!'</span>,<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">                <span class="comment">//弹窗关闭后回到主界面</span></div><div class="line">                Element.$body.removeClass();</div><div class="line">                Element.$catchBox.removeClass(<span class="string">'catchfail'</span>);</div><div class="line">                State.catching = <span class="literal">false</span>;</div><div class="line">            &#125;);</div><div class="line">        &#125;,<span class="number">1500</span>);</div><div class="line">    &#125;</div><div class="line">    State.catching = <span class="literal">true</span>;</div><div class="line">&#125;,</div></pre></td></tr></table></figure>
<p>捕捉成功与失败：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> awardBox = <span class="function"><span class="keyword">function</span>(<span class="params">img,name,callback</span>)</span>&#123;</div><div class="line">    <span class="keyword">var</span> cbk = callback || <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;&#125;;</div><div class="line">    Element.$award.addClass(<span class="string">'show'</span>);</div><div class="line">    Element.$award.find(<span class="string">'.img'</span>).attr(<span class="string">'src'</span>,img);</div><div class="line">    Element.$award.find(<span class="string">'.pname'</span>).text(name);</div><div class="line">    Element.$award.find(<span class="string">'.confirm'</span>).off().on(<span class="string">'tap'</span>,<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">        Element.$award.removeClass(<span class="string">'show'</span>);</div><div class="line">        cbk();</div><div class="line">    &#125;);</div><div class="line">&#125;,</div><div class="line"><span class="keyword">const</span> alertBox = <span class="function"><span class="keyword">function</span>(<span class="params">title,callback</span>)</span>&#123;</div><div class="line">    <span class="keyword">var</span> cbk = callback || <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;&#125;;</div><div class="line">    Element.$alert.addClass(<span class="string">'show'</span>);</div><div class="line">    Element.$alert.find(<span class="string">'.heading'</span>).text(title);</div><div class="line">    Element.$alert.find(<span class="string">'.confirm'</span>).off().on(<span class="string">'tap'</span>,<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">        Element.$alert.removeClass(<span class="string">'show'</span>);</div><div class="line">        cbk();</div><div class="line">    &#125;);</div><div class="line">&#125;,</div></pre></td></tr></table></figure>
<p>捕捉失败过程：</p>
<p><img src="../images/pokemon/17.gif" alt="图片描述"></p>
<p>捕捉成功过程：</p>
<p><img src="../images/pokemon/18.gif" alt="图片描述"></p>
<p><a href="https://www.guowc.cc/go/demo8.html" target="_blank" rel="external">查看DEMO</a></p>
<h3 id="十一、大木博士"><a href="#十一、大木博士" class="headerlink" title="十一、大木博士"></a>十一、大木博士</h3><p>在大木博士的实验室，小智得到了第一个精灵伙伴，那里是梦开始的地方。为了还原经典，我们加入一个简单的新手引导，通过与大木博士的对话，确定用户的性别，第一个伙伴，和简单的游戏玩法介绍。</p>
<p><img src="../images/pokemon/19.png" alt="clipboard.png"></p>
<p>首先实现一个简单的打字效果：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line">typing(char,delay) &#123;</div><div class="line">    <span class="keyword">var</span> chars = char.split(<span class="string">''</span>);</div><div class="line">    <span class="keyword">var</span> index = <span class="number">0</span>,</div><div class="line">        delay = <span class="number">0</span>;</div><div class="line"></div><div class="line">    Element.$typeText.html(<span class="string">''</span>);</div><div class="line">    Element.$typeNext.hide();   <span class="comment">//打字过程隐藏下一步箭头</span></div><div class="line">    State.typeOver = <span class="literal">false</span>;</div><div class="line">    <span class="keyword">var</span> timer = setInterval(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">        <span class="keyword">if</span>(delay == delay)&#123;</div><div class="line">            <span class="keyword">if</span>(index == chars.length)&#123;</div><div class="line">                clearInterval(timer);</div><div class="line">                State.typeOver = <span class="literal">true</span>;</div><div class="line">                Element.$typeNext.show();</div><div class="line">                <span class="keyword">return</span>;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span>(chars[index] == <span class="string">'/'</span>)&#123;</div><div class="line">                Element.$typeText.append(<span class="string">'&lt;br&gt;'</span>);  <span class="comment">//判断换行位置</span></div><div class="line">            &#125;<span class="keyword">else</span>&#123;</div><div class="line">                Element.$typeText.append(chars[index]);</div><div class="line">            &#125;</div><div class="line">            index ++;</div><div class="line">        &#125;<span class="keyword">else</span>&#123;</div><div class="line">            delay ++ ;</div><div class="line">        &#125;</div><div class="line">    &#125;,<span class="number">50</span>);</div><div class="line">&#125;,</div></pre></td></tr></table></figure>
<p>然后初始化新手引导：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> initGuide = <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">    <span class="keyword">var</span> self = <span class="keyword">this</span>;</div><div class="line">    <span class="keyword">var</span> sex = <span class="number">1</span>, pokenum = <span class="string">'001'</span>, typeIndex = <span class="number">0</span>;</div><div class="line"></div><div class="line">    Method.typing(<span class="string">'欢迎来到精灵世界/我是大木博士'</span>,<span class="number">10</span>);</div><div class="line"></div><div class="line">    Element.$modal.removeClass(<span class="string">'show'</span>);  <span class="comment">//隐藏所有弹窗</span></div><div class="line">    Element.$modalGuide.addClass(<span class="string">'show'</span>); <span class="comment">//显示新手引导弹窗</span></div><div class="line">    Element.$body.addClass(<span class="string">'blur'</span>);  <span class="comment">//背景模糊</span></div><div class="line"></div><div class="line">    Element.$typeBox.bind(<span class="string">'tap'</span>,<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">        <span class="comment">//开始对话</span></div><div class="line">        <span class="keyword">if</span>(!State.typeOver) <span class="keyword">return</span>;</div><div class="line">        typeIndex ++;    </div><div class="line">        <span class="keyword">switch</span> (typeIndex) &#123;</div><div class="line">            <span class="keyword">case</span> <span class="number">1</span>:</div><div class="line">                Method.typing(<span class="string">'这个世界到处都有精灵的存在/许多人把精灵当做伙伴'</span>,<span class="number">0</span>);</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">case</span> <span class="number">2</span>:</div><div class="line">                Method.typing(<span class="string">'那么你是男孩还是女孩？/(选择角色)'</span>,<span class="number">0</span>);</div><div class="line">                Element.$modalGuide.addClass(<span class="string">'setrole'</span>);  <span class="comment">//进入选择角色界面</span></div><div class="line">                Element.$setRole.bind(<span class="string">'tap'</span>,<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">                    $(<span class="keyword">this</span>).addClass(<span class="string">'selected'</span>).siblings().removeClass(<span class="string">'selected'</span>);</div><div class="line">                    sex = $(<span class="keyword">this</span>).data(<span class="string">'sex'</span>);</div><div class="line">                &#125;);</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">case</span> <span class="number">3</span>:</div><div class="line">                Method.typing(<span class="string">'选择一只精灵作为你的伙伴吧/(选择精灵)'</span>,<span class="number">0</span>);</div><div class="line">                Element.$modalGuide.removeClass(<span class="string">'setrole'</span>).addClass(<span class="string">'setpoke'</span>);  <span class="comment">//进入选择精灵界面</span></div><div class="line">                Element.$setPoke.bind(<span class="string">'tap'</span>,<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">                    $(<span class="keyword">this</span>).addClass(<span class="string">'selected'</span>).siblings().removeClass(<span class="string">'selected'</span>);</div><div class="line">                    pokenum = $(<span class="keyword">this</span>).data(<span class="string">'number'</span>);</div><div class="line">                    Element.$setFigure[<span class="number">0</span>].className = <span class="string">'img-'</span> + pokenum;</div><div class="line">                &#125;);</div><div class="line">                Method.setItem(<span class="string">'sex'</span>,sex);</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">case</span> <span class="number">4</span>:</div><div class="line">                Method.typing(<span class="string">'点击周围的小精灵即可抓捕!/(操作方式)'</span>,<span class="number">0</span>);</div><div class="line">                Element.$modalGuide.removeClass(<span class="string">'setpoke'</span>);</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">case</span> <span class="number">5</span>:</div><div class="line">                Method.typing(<span class="string">'移动可能遇到随机出现的稀有精灵哦!/(随机事件)'</span>,<span class="number">0</span>);</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">case</span> <span class="number">6</span>:</div><div class="line">                Method.typing(<span class="string">'请带上你的伙伴去冒险吧!'</span>,<span class="number">0</span>);</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">case</span> <span class="number">7</span>:</div><div class="line">                Element.$modalGuide.removeClass(<span class="string">'show'</span>);</div><div class="line">                Element.$body.removeClass(<span class="string">'blur'</span>);</div><div class="line">                self.ready();</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">default</span>:</div><div class="line">        &#125;</div><div class="line">    &#125;);</div><div class="line">&#125;,</div></pre></td></tr></table></figure>
<p><a href="https://www.guowc.cc/go/demo9.html" target="_blank" rel="external">查看DEMO</a></p>
<h3 id="十二、完善更多"><a href="#十二、完善更多" class="headerlink" title="十二、完善更多"></a>十二、完善更多</h3><p>最后把界面上的一些数据展示的功能补上：</p>
<h4 id="Loading"><a href="#Loading" class="headerlink" title="Loading"></a>Loading</h4><p><img src="../images/pokemon/20.gif" alt="图片描述"></p>
<h4 id="精灵刷新倒计时"><a href="#精灵刷新倒计时" class="headerlink" title="精灵刷新倒计时"></a>精灵刷新倒计时</h4><p><img src="../images/pokemon/21.gif" alt="图片描述"></p>
<h4 id="系统公告"><a href="#系统公告" class="headerlink" title="系统公告"></a>系统公告</h4><p><img src="../images/pokemon/22.gif" alt="图片描述"></p>
<h4 id="Toast提示"><a href="#Toast提示" class="headerlink" title="Toast提示"></a>Toast提示</h4><p><img src="../images/pokemon/23.gif" alt="图片描述"></p>
<h4 id="训练师信息"><a href="#训练师信息" class="headerlink" title="训练师信息"></a>训练师信息</h4><p><img src="../images/pokemon/24.gif" alt="图片描述"></p>
<h4 id="精灵背包"><a href="#精灵背包" class="headerlink" title="精灵背包"></a>精灵背包</h4><p><img src="../images/pokemon/25.gif" alt="图片描述"></p>
<h4 id="精灵图鉴"><a href="#精灵图鉴" class="headerlink" title="精灵图鉴"></a>精灵图鉴</h4><p><img src="../images/pokemon/26.gif" alt="图片描述"></p>
<h4 id="精灵大师榜"><a href="#精灵大师榜" class="headerlink" title="精灵大师榜"></a>精灵大师榜</h4><p><img src="../images/pokemon/27.gif" alt="图片描述"></p>
<p>最后附上完整版地址：</p>
<p><img src="../images/pokemon/28.png" alt="clipboard.png"></p>

            </section>
            <footer class="article-meta">
                <!--  -->
            </footer>
        </article>
    </div>
</div>

<footer class="footer text-center">
    <div class="container">
        <section class="copyright">
            <a href="http://fe.meitu.com/">MEITU FE</a>
            <span>&copy; 2017</span>
        </section>
    </div>
</footer>

    <script src="/dist/js/highlight.pack.js"></script>
    <script src="/dist/js/app.js"></script>
</body>
</html>

